#!/bin/bash

if [ $# -lt 3 ];then
	echo0 5 "$0 in.macs2.peaks genome out.prefix"
	exit 1
fi
PATH_PROG=`dirname $0` && PATH_ANNO=${PATH_PROG%/bin}/annotation

### promoter
intersectBed -a ${PATH_ANNO}/$2/$2.TSS.+-500bp.bed -b $1 -wo | awk 'BEGIN{FS=OFS="\t"} {a[$4]=1} END{for(i in a){print i,"promoter"}}' > $3.promoter.temp
### gene
awk 'BEGIN{FS=OFS="\t"} {if(ARGIND==1){a[$1]=1}else{if(!a[$4]){print $0}}}' $3.promoter.temp ${PATH_ANNO}/$2/$2.gene.bed > $3.temp.gene.bed
intersectBed -a $3.temp.gene.bed -b $1 -wo | awk 'BEGIN{FS=OFS="\t"} {a[$4]=1} END{for(i in a){print i}}' > $3.gene.temp
# exon
awk 'BEGIN{FS=OFS="\t"} {if(ARGIND==1){a[$1]=1}else{if(a[$4]){print $0}}}' $3.gene.temp ${PATH_ANNO}/$2/$2.exon.bed > $3.temp.exon.bed
intersectBed -a $3.temp.exon.bed -b $1 -wo | awk 'BEGIN{FS=OFS="\t"} {a[$4]=1} END{for(i in a){print i,"exon"}}' > $3.exon.temp
# intron
awk 'BEGIN{FS=OFS="\t"} {if(ARGIND==1){a[$1]=1}else{if(!a[$1]){print $1,"intron"}}}' $3.exon.temp $3.gene.temp > $3.intron.temp
cat $3.promoter.temp $3.exon.temp $3.intron.temp | awk 'BEGIN{FS=OFS="\t"} {if(ARGIND==1){a[$1]=$0}else{if(a[$4]){print a[$4]}else{print $4,"none"}}}' - ${PATH_ANNO}/$2/$2.gene.bed | sort -k1,1 > $3.peakAtGene.temp
# distance to TSS
bedtools closest -a ${PATH_ANNO}/$2/$2.TSS.bed -b $1 -d | awk 'BEGIN{FS=OFS="\t"} {if(ARGIND==1){if(!a[$4]){a[$4]=$17}else{if($17<a[$4]){a[$4]=$17}}}else{if(a[$1]!=""){print $1,$2,a[$1]}else{print $1,$2,1000000}}}' - $3.peakAtGene.temp > $3.peakAtGene.txt
rm $3.*.temp $3.temp.*.bed
